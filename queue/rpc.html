
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>RPC · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="publisher_confirms.html" />
    
    
    <link rel="prev" href="topics.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    开始
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    消息队列模式
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="hello_world.html">
            
                <a href="hello_world.html">
            
                    
                    Hello World
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="work_queues.html">
            
                <a href="work_queues.html">
            
                    
                    Work queues
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="publish_subscribe.html">
            
                <a href="publish_subscribe.html">
            
                    
                    Publish / Subscribe 
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="routing.html">
            
                <a href="routing.html">
            
                    
                    Routing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="topics.html">
            
                <a href="topics.html">
            
                    
                    Topics
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.2.6" data-path="rpc.html">
            
                <a href="rpc.html">
            
                    
                    RPC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.7" data-path="publisher_confirms.html">
            
                <a href="publisher_confirms.html">
            
                    
                    Publisher Confirms
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    服务端文档(Server Documentation)
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../server/configuration.md">
            
                <span>
            
                    
                    Configuration
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <span>
            
                    
                    分布式RabbitMQ(Distributed RabbitMQ)
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../distribute/overview.html">
            
                <a href="../distribute/overview.html">
            
                    
                    概述（Mirroring, Shovel, Federation Overview）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../distribute/clustering.html">
            
                <a href="../distribute/clustering.html">
            
                    
                    Clustering
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" >
            
                <a target="_blank" href="https://www.rabbitmq.com/ha.html">
            
                    
                    Queue Mirroring
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" >
            
                <a target="_blank" href="https://www.rabbitmq.com/reliability.html">
            
                    
                    Reliable Message Delivery
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" >
            
                <a target="_blank" href="https://www.rabbitmq.com/pacemaker.html">
            
                    
                    highly available
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >RPC</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h4 id="&#x5185;&#x5BB9;&#x6458;&#x8981;">&#x5185;&#x5BB9;&#x6458;&#x8981;</h4>
<blockquote>
<p>In the <a href="https://www.rabbitmq.com/tutorials/tutorial-two-python.html" target="_blank">second tutorial</a> we learned how to use <em>Work Queues</em> to distribute time-consuming tasks among multiple workers.</p>
<p>But what if we need to run a function on a remote computer and wait for the result? Well, that&apos;s a different story. This pattern is commonly known as <em>Remote Procedure Call</em> or <em>RPC</em>.</p>
<p>In this tutorial we&apos;re going to use RabbitMQ to build an RPC system: a client and a scalable RPC server. As we don&apos;t have any time-consuming tasks that are worth distributing, we&apos;re going to create a dummy RPC service that returns Fibonacci numbers.</p>
</blockquote>
<p>&#x5728;<a href="worker.md">&#x7B2C;&#x4E8C;&#x7BC7;</a>&#x6559;&#x7A0B;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5B66;&#x5230;&#x4E86;&#x5982;&#x4F55;&#x4F7F;&#x7528;Work Queues&#x5728;&#x591A;&#x4E2A;workers&#x4E2D;&#x5206;&#x53D1;&#x8017;&#x65F6;&#x4EFB;&#x52A1;&#x3002;</p>
<p>&#x4F46;&#x662F;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x8FD0;&#x884C;&#x4E00;&#x4E2A;&#x5728;&#x8FDC;&#x7AEF;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x5E76;&#x7B49;&#x5F85;&#x7ED3;&#x679C;&#x5462;&#xFF1F;&#x8FD9;&#x4E00;&#x90E8;&#x5206;&#x5C31;&#x662F;&#x4F17;&#x6240;&#x5468;&#x77E5;&#x7684;RPC(Remote Procedure Call)</p>
<p>&#x8FD9;&#x4E00;&#x7BC7;&#x6211;&#x4EEC;&#x5C06;&#x7528;RabbitMQ&#x6765;&#x642D;&#x5EFA;&#x4E00;&#x4E2A;RPC&#x7CFB;&#x7EDF;&#xFF1A;&#x4E00;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x4E00;&#x4E2A;&#x53EF;&#x4F38;&#x7F29;&#x7684;RPC&#x670D;&#x52A1;&#x5668;&#x3002;&#x7531;&#x4E8E;&#x6211;&#x4EEC;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x503C;&#x5F97;&#x5206;&#x914D;&#x7684;&#x8017;&#x65F6;&#x4EFB;&#x52A1;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x5C06;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x8FD4;&#x56DE;&#x6590;&#x6CE2;&#x7EB3;&#x5951;&#x6570;&#x7684;&#x4F2A;RPC&#x670D;&#x52A1;&#x3002;</p>
<h4 id="client-interface">Client interface</h4>
<blockquote>
<p>To illustrate how an RPC service could be used we&apos;re going to create a simple client class. It&apos;s going to expose a method named call which sends an RPC request and blocks until the answer is received:</p>
</blockquote>
<p>&#x4E3A;&#x4E86;&#x9610;&#x8FF0;&#x4E00;&#x4E2A;RPC&#x670D;&#x52A1;&#x5982;&#x4F55;&#x88AB;&#x4F7F;&#x7528;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x8981;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;client&#x7C7B;&#xFF0C;&#x5B83;&#x4F1A;&#x66B4;&#x9732;&#x51FA;&#x4E00;&#x4E2A;&#x53EB;&#x505A;call&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x7528;&#x6765;&#x53D1;&#x9001;&#x4E00;&#x4E2A;RPC&#x8BF7;&#x6C42;&#xFF0C;&#x5E76;&#x4E14;&#x4E00;&#x76F4;&#x963B;&#x585E;&#x76F4;&#x5230;&#x7ED3;&#x679C;&#x8FD4;&#x56DE;&#x3002;</p>
<pre><code class="lang-python">fibonacci_rpc = FibonacciRpcClient()
result = fibonacci_rpc.call(<span class="hljs-number">4</span>)
print(<span class="hljs-string">&quot;fib(4) is %r&quot;</span> % result)
</code></pre>
<h4 id="a-note-on-rpc">A note on RPC</h4>
<blockquote>
<p>Although RPC is a pretty common pattern in computing, it&apos;s often criticised. The problems arise when a programmer is not aware whether a function call is local or if it&apos;s a slow RPC. Confusions like that result in an unpredictable system and adds unnecessary complexity to debugging. Instead of simplifying software, misused RPC can result in unmaintainable spaghetti code.</p>
<p>Bearing that in mind, consider the following advice:</p>
<ul>
<li>Make sure it&apos;s obvious which function call is local and which is remote.</li>
<li>Document your system. Make the dependencies between components clear.</li>
<li>Handle error cases. How should the client react when the RPC server is down for a long time?</li>
</ul>
<p>When in doubt avoid RPC. If you can, you should use an asynchronous pipeline - instead of RPC-like blocking, results are asynchronously pushed to a next computation stage.</p>
</blockquote>
<p>&#x867D;&#x7136;&#x628A;RPC&#x8FD0;&#x7528;&#x5728;&#x8BA1;&#x7B97;&#x4E2D;&#x662F;&#x76F8;&#x5F53;&#x666E;&#x904D;&#x7684;&#x6A21;&#x5F0F;&#xFF0C;&#x4F46;&#x662F;&#x5B83;&#x9971;&#x53D7;&#x6279;&#x8BC4;&#x3002;&#x95EE;&#x9898;&#x6E90;&#x81EA;&#x4E8E;&#x5F53;&#x4E00;&#x4E2A;&#x7A0B;&#x5E8F;&#x5458;&#x672A;&#x5BDF;&#x89C9;&#x5230;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x662F;&#x672C;&#x5730;&#x7684;&#x8FD8;&#x662F;&#x4E00;&#x4E2A;&#x6162;&#x7684;RPC&#xFF0C;&#x7C7B;&#x4F3C;&#x8FD9;&#x79CD;&#x56F0;&#x60D1;&#x4F1A;&#x5BFC;&#x81F4;&#x4EA7;&#x751F;&#x4E00;&#x4E2A;&#x4E0D;&#x53EF;&#x9884;&#x6D4B;&#x7684;&#x7CFB;&#x7EDF;&#xFF0C;&#x4E5F;&#x4F1A;&#x7ED9;debugging&#x5E26;&#x6765;&#x4E0D;&#x5FC5;&#x8981;&#x7684;&#x590D;&#x6742;&#x6027;&#x3002;&#x6EE5;&#x7528;RPC&#x4F1A;&#x5BFC;&#x81F4;&#x4E0D;&#x53EF;&#x7EF4;&#x62A4;&#x7684;&#x610F;&#x5927;&#x5229;&#x9762;&#x6761;&#x4EE3;&#x7801;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x7B80;&#x5316;&#x8F6F;&#x4EF6;&#x3002;</p>
<p>&#x8BB0;&#x4F4F;&#x8FD9;&#x4E9B;&#xFF0C;&#x5E76;&#x8003;&#x8651;&#x4E00;&#x4E0B;&#x5EFA;&#x8BAE;&#xFF1A;</p>
<ul>
<li>&#x786E;&#x4FDD;&#x80FD;&#x5F88;&#x660E;&#x663E;&#x7684;&#x533A;&#x5206;&#x51FD;&#x6570;&#x662F;&#x672C;&#x5730;&#x7684;&#x8FD8;&#x662F;&#x8FDC;&#x7A0B;&#x8C03;&#x7528;</li>
<li>&#x5199;&#x597D;&#x7CFB;&#x7EDF;&#x6587;&#x6863;&#xFF0C;&#x786E;&#x4FDD;&#x4E0D;&#x540C;&#x7EC4;&#x4EF6;&#x4E4B;&#x95F4;&#x7684;&#x4F9D;&#x8D56;&#x5173;&#x7CFB;&#x6E05;&#x6670;</li>
<li>&#x5904;&#x7406;&#x51FA;&#x73B0;&#x9519;&#x8BEF;&#x7684;&#x72B6;&#x51B5;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x5E94;&#x8BE5;&#x600E;&#x4E48;&#x5E94;&#x5BF9;RPC &#x670D;&#x52A1;&#x5668;&#x6302;&#x6389;&#x4E86;&#x5F88;&#x957F;&#x65F6;&#x95F4;</li>
</ul>
<p>&#x6709;&#x7591;&#x60D1;&#x7684;&#x8BDD;&#xFF0C;&#x5C31;&#x4E0D;&#x8981;&#x4F7F;&#x7528;RPC&#x3002;&#x5982;&#x679C;&#x53EF;&#x4EE5;&#x7684;&#x8BDD;&#xFF0C;&#x4F60;&#x5E94;&#x8BE5;&#x4F7F;&#x7528;&#x5F02;&#x6B65;&#x7BA1;&#x9053;&#x800C;&#x4E0D;&#x662F;&#x963B;&#x585E;&#x7684;RPC&#xFF0C;&#x5C06;&#x7ED3;&#x679C;&#x5F02;&#x6B65;&#x7684;&#x63A8;&#x9001;&#x5230;&#x4E0B;&#x4E00;&#x4E2A;&#x8BA1;&#x7B97;&#x9636;&#x6BB5;&#x3002;</p>
<h3 id="callback-queue">Callback queue</h3>
<blockquote>
<p>In general doing RPC over RabbitMQ is easy. A client sends a request message and a server replies with a response message. In order to receive a response the client needs to send a &apos;callback&apos; queue address with the request. Let&apos;s try it:</p>
</blockquote>
<p>&#x603B;&#x7684;&#x6765;&#x8BF4;&#x7528;RabbitMQ&#x6765;&#x505A;RPC&#x5F88;&#x7B80;&#x5355;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001;&#x8BF7;&#x6C42;&#x4FE1;&#x606F;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x56DE;&#x590D;&#x54CD;&#x5E94;&#x4FE1;&#x606F;&#x3002;&#x4E3A;&#x4E86;&#x63A5;&#x6536;&#x54CD;&#x5E94;&#x4FE1;&#x606F;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x9700;&#x8981;&#x53D1;&#x9001; &#x4E00;&#x4E2A;&#x5E26;&#x6709;&#x56DE;&#x8C03;&#x961F;&#x5217;&#x540D;&#x79F0;&#x7684;&#x8BF7;&#x6C42;&#x3002;&#xFF08;&#x5BA2;&#x6237;&#x7AEF;&#x751F;&#x6210;&#x6D88;&#x606F;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6D88;&#x606F;&#x4F1A;&#x5E26;&#x4E0A;&#x4E00;&#x4E2A;&#x5C5E;&#x6027;reply_to&#xFF0C;&#x7528;&#x6765;&#x6807;&#x793A;&#x53BB;&#x54EA;&#x4E2A;&#x961F;&#x5217;&#x83B7;&#x53D6;&#x8FD4;&#x56DE;&#x4FE1;&#x606F;&#xFF09;</p>
<pre><code class="lang-python">result = channel.queue_declare(queue=<span class="hljs-string">&apos;&apos;</span>, exclusive=<span class="hljs-keyword">True</span>)
callback_queue = result.method.queue

channel.basic_publish(exchange=<span class="hljs-string">&apos;&apos;</span>,
                      routing_key=<span class="hljs-string">&apos;rpc_queue&apos;</span>,
                      properties=pika.BasicProperties(
                            reply_to = callback_queue,
                            ),
                      body=request)

<span class="hljs-comment"># ... and some code to read a response message from the callback_queue ...</span>
</code></pre>
<h4 id="message-properties">Message properties</h4>
<blockquote>
<p> The AMQP 0-9-1 protocol predefines a set of 14 properties that go with a message. Most of the properties are rarely used, with the exception of the following:</p>
<ul>
<li><code>delivery_mode</code>: Marks a message as persistent (with a value of 2) or transient (any other value). You may remember this property from <a href="https://www.rabbitmq.com/tutorials/tutorial-two-python.html" target="_blank">the second tutorial</a>.</li>
<li><code>content_type</code>: Used to describe the mime-type of the encoding. For example for the often used JSON encoding it is a good practice to set this property to: application/json.</li>
<li><code>reply_to</code>: Commonly used to name a callback queue.</li>
<li><code>correlation_id</code>: Useful to correlate RPC responses with requests.</li>
</ul>
</blockquote>
<p>AMQP&#x534F;&#x8BAE;&#x7ED9;&#x6D88;&#x606F;&#x9884;&#x5B9A;&#x4E49;&#x4E86;14&#x4E2A;&#x5C5E;&#x6027;&#xFF0C;&#x5176;&#x4E2D;&#x5927;&#x90E8;&#x5206;&#x90FD;&#x5F88;&#x5C11;&#x4F7F;&#x7528;&#xFF0C;&#x9664;&#x4E86;&#x4EE5;&#x4E0B;&#x51E0;&#x70B9;&#xFF1A;</p>
<ul>
<li><code>delivery_mode</code>:  &#x6807;&#x8BB0;&#x6D88;&#x606F;&#x4E3A;&#x6301;&#x4E45;&#x7684;(&#x503C;&#x4E3A;2) &#x6216;&#x8005; &#x77ED;&#x6682;&#x7684; (&#x5176;&#x4ED6;&#x4EFB;&#x4F55;&#x503C;)&#xFF0C;&#x5728;<a href="work_queues.html">work_queues</a>&#x4E2D;&#x8BB2;&#x8FC7;&#x8BE5;&#x5C5E;&#x6027;</li>
<li><code>content_type</code>: &#x7528;&#x6765;&#x63CF;&#x8FF0;mime-type&#x7684;&#x7F16;&#x7801;&#x3002;&#x4F8B;&#x5982;&#x5BF9;&#x4E8E;&#x7ECF;&#x5E38;&#x4F7F;&#x7528;&#x7684;JSON&#x7F16;&#x7801;&#xFF0C;&#x628A;&#x8FD9;&#x4E2A;&#x5C5E;&#x6027;&#x8BBE;&#x7F6E;&#x4E3A;<code>application/json</code>&#x662F;&#x4E00;&#x4E2A;&#x6BD4;&#x8F83;&#x597D;&#x7684;&#x9009;&#x62E9;&#x3002;</li>
<li><code>reply_to</code>: &#x901A;&#x5E38;&#x7528;&#x6765;&#x63D0;&#x524D;&#x6807;&#x793A;&#x4E00;&#x4E2A;&#x56DE;&#x8C03;&#x961F;&#x5217;&#x7684;&#x540D;&#x5B57;</li>
<li><code>correlation_id</code>:  &#x5C06;RPC&#x54CD;&#x5E94;&#x548C;&#x8BF7;&#x6C42;&#x5173;&#x8054;&#x8D77;&#x6765;</li>
</ul>
<h3 id="correlation-id">Correlation id</h3>
<blockquote>
<p>In the method presented above we suggest creating a callback queue for every RPC request. That&apos;s pretty inefficient, but fortunately there is a better way - let&apos;s create a single callback queue per client.</p>
<p>That raises a new issue, having received a response in that queue it&apos;s not clear to which request the response belongs. That&apos;s when the correlation_id property is used. We&apos;re going to set it to a unique value for every request. Later, when we receive a message in the callback queue we&apos;ll look at this property, and based on that we&apos;ll be able to match a response with a request. If we see an unknown correlation_id value, we may safely discard the message - it doesn&apos;t belong to our requests.</p>
<p>You may ask, why should we ignore unknown messages in the callback queue, rather than failing with an error? It&apos;s due to a possibility of a race condition on the server side. Although unlikely, it is possible that the RPC server will die just after sending us the answer, but before sending an acknowledgment message for the request. If that happens, the restarted RPC server will process the request again. That&apos;s why on the client we must handle the duplicate responses gracefully, and the RPC should ideally be idempotent.</p>
</blockquote>
<p>&#x5728;&#x4E4B;&#x524D;&#x7684;&#x65B9;&#x6CD5;&#x4E2D;&#x6211;&#x4EEC;&#x5EFA;&#x8BAE;&#x9488;&#x5BF9;&#x6240;&#x6709;&#x7684;RPC&#x8BF7;&#x6C42;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;callback&#x961F;&#x5217;&#xFF0C;&#x8FD9;&#x6837;&#x76F8;&#x5F53;&#x7684;&#x4F4E;&#x6548;&#xFF0C;&#x4F46;&#x5E78;&#x8FD0;&#x7684;&#x662F;&#x6709;&#x4E00;&#x79CD;&#x66F4;&#x597D;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x8BA9;&#x6211;&#x4EEC;&#x5BF9;&#x6BCF;&#x4E00;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;callback&#x961F;&#x5217;&#x3002;</p>
<p>&#x8FD9;&#x5F15;&#x53D1;&#x4E86;&#x4E00;&#x4E2A;&#x65B0;&#x95EE;&#x9898;&#xFF0C;&#x5728;&#x961F;&#x5217;&#x91CC;&#x63A5;&#x6536;&#x5230;&#x4E00;&#x4E2A;&#x54CD;&#x5E94;&#xFF0C;&#x4F46;&#x662F;&#x4E0D;&#x77E5;&#x9053;&#x5C5E;&#x4E8E;&#x54EA;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x3002;&#x8FD9;&#x5C31;&#x662F;correlation_id&#x7684;&#x4F5C;&#x7528;&#xFF0C;&#x6211;&#x4EEC;&#x8981;&#x7ED9;&#x6BCF;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x8BBE;&#x7F6E;&#x552F;&#x4E00;&#x7684;&#x503C;&#xFF0C;&#x4E4B;&#x540E;&#xFF0C;&#x5F53;&#x6211;&#x4EEC;&#x518D;callback&#x961F;&#x5217;&#x91CC;&#x9762;&#x63A5;&#x6536;&#x5230;&#x6D88;&#x606F;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6211;&#x4EEC;&#x518D;&#x67E5;&#x770B;&#x8FD9;&#x4E2A;&#x5C5E;&#x6027;&#xFF0C;&#x7136;&#x540E;&#x4F9D;&#x9760;&#x8FD9;&#x4E2A;&#x6211;&#x4EEC;&#x80FD;&#x628A;&#x8BF7;&#x6C42;&#x548C;&#x54CD;&#x5E94;&#x5BF9;&#x5E94;&#x8D77;&#x6765;&#x3002;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x9047;&#x5230;&#x4E00;&#x4E2A;&#x672A;&#x77E5;&#x7684;correlation_id&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5B89;&#x5168;&#x7684;&#x4E22;&#x5F03;&#x8BE5;&#x6D88;&#x606F;&#xFF0C;&#x5B83;&#x4E0D;&#x662F;&#x6211;&#x4EEC;&#x8BF7;&#x6C42;&#x7684;&#x54CD;&#x5E94;&#x3002;</p>
<p>&#x4F60;&#x53EF;&#x80FD;&#x56DE;&#x95EE;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x5FFD;&#x7565;callback&#x961F;&#x5217;&#x4E2D;&#x672A;&#x77E5;&#x7684;&#x6D88;&#x606F;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x4EA7;&#x751F;&#x4E00;&#x4E2A;&#x62A5;&#x9519;&#xFF1F;&#x8FD9;&#x662F;&#x7531;&#x4E8E;&#x670D;&#x52A1;&#x5668;&#x5B58;&#x5728;&#x7ADE;&#x4E89;&#x5173;&#x7CFB;&#xFF0C;&#x867D;&#x7136;&#x4E0D;&#x592A;&#x53EF;&#x80FD;&#xFF0C;&#x4F46;&#x662F;RPC&#x670D;&#x52A1;&#x5668;&#x53EF;&#x80FD;&#x5728;&#x53D1;&#x9001;&#x5B8C;&#x54CD;&#x5E94;&#x540E;&#xFF0C;&#x53D1;&#x9001;ack&#x4E4B;&#x524D;&#x6302;&#x6389;&#xFF0C;&#x5982;&#x679C;&#x53D1;&#x751F;&#x4E86;&#x7684;&#x8BDD;&#xFF0C;RPC&#x670D;&#x52A1;&#x5668;&#x91CD;&#x542F;&#x540E;&#x4F1A;&#x518D;&#x6B21;&#x5904;&#x7406;&#x8FD9;&#x4E2A;&#x8BF7;&#x6C42;&#xFF0C;&#x8FD9;&#x5C31;&#x662F;&#x4E3A;&#x4EC0;&#x4E48;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x5FC5;&#x987B;&#x4F18;&#x96C5;&#x5730;&#x5904;&#x7406;&#x91CD;&#x590D;&#x7684;&#x54CD;&#x5E94;&#xFF0C;&#x7406;&#x60F3;&#x72B6;&#x51B5;&#x4E0B;&#xFF0C;RPC&#x5E94;&#x8BE5;&#x662F;&#x5E42;&#x7B49;&#x7684;&#x3002;</p>
<h4 id="&#x603B;&#x7ED3;">&#x603B;&#x7ED3;</h4>
<p><img src="images/rpc.png" alt="rpc" style="zoom:50%;"></p>
<blockquote>
<p>Our RPC will work like this:</p>
<ul>
<li>When the Client starts up, it creates an anonymous exclusive callback queue.</li>
<li>For an RPC request, the Client sends a message with two properties: reply_to, which is set to the callback queue and correlation_id, which is set to a unique value for every request.</li>
<li>The request is sent to an rpc_queue queue.</li>
<li>The RPC worker (aka: server) is waiting for requests on that queue. When a request appears, it does the job and sends a message with the result back to the Client, using the queue from the reply_to field.</li>
<li>The client waits for data on the callback queue. When a message appears, it checks the correlation_id property. If it matches the value from the request it returns the response to the application.</li>
</ul>
</blockquote>
<p>&#x6211;&#x4EEC;&#x7684;RPC&#x4F1A;&#x8FD9;&#x6837;&#x8FD0;&#x884C;&#xFF1A;</p>
<ul>
<li>&#x5F53;&#x5BA2;&#x6237;&#x7AEF;&#x542F;&#x52A8;&#x65F6;&#xFF0C;&#x5B83;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x533F;&#x540D;&#x7684;&#xFF0C;&#x72EC;&#x5360;&#x7684;callback&#x961F;&#x5217;&#xFF08;&#x6D88;&#x8D39;&#x8005;&#x8FDE;&#x63A5;&#x5173;&#x95ED;&#x540E;&#xFF0C;&#x81EA;&#x52A8;&#x5220;&#x9664;&#x961F;&#x5217;&#xFF09;</li>
<li>&#x5BF9;&#x4E8E;RPC&#x8BF7;&#x6C42;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x5E26;&#x6709;&#x4E24;&#x4E2A;&#x53C2;&#x6570;&#x7684;&#x6D88;&#x606F;&#xFF0C;reply_to&#x4EE3;&#x8868;&#x56DE;&#x8C03;&#x961F;&#x5217;&#x7684;&#x961F;&#x5217;&#x540D;&#xFF0C;correlation_id&#x4EE3;&#x8868;&#x6BCF;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x7684;&#x552F;&#x4E00;&#x503C;</li>
<li>&#x8FD9;&#x4E2A;&#x8BF7;&#x6C42;&#x88AB;&#x53D1;&#x9001;&#x5230;&#x4E86;rpc_queue&#x961F;&#x5217;</li>
<li>RPC worker(&#x53C8;&#x540D; server)&#xFF0C;&#x5728;rpc_queue&#x961F;&#x5217;&#x4E0A;&#x7B49;&#x5F85;&#x8BF7;&#x6C42;&#xFF0C;&#x5F53;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x6765;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F7F;&#x7528;reply_to&#x6807;&#x793A;&#x7684;&#x961F;&#x5217;&#xFF0C;&#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x5E26;&#x6709;&#x7ED3;&#x679C;&#x7684;&#x6D88;&#x606F;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;</li>
<li>&#x5BA2;&#x6237;&#x7AEF;&#x5728;&#x56DE;&#x8C03;&#x961F;&#x5217;&#x4E0A;&#x7B49;&#x5F85;&#x6570;&#x636E;&#xFF0C;&#x5F53;&#x6D88;&#x606F;&#x5230;&#x6765;&#x65F6;&#xFF0C;&#x68C0;&#x67E5;correlation_id&#x53C2;&#x6570;&#xFF0C;&#x5982;&#x679C;&#x80FD;&#x8DDF;&#x8BF7;&#x6C42;&#x7684;&#x503C;&#x5339;&#x914D;&#x4E0A;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;&#x8FD9;&#x4E2A;&#x7ED3;&#x679C;&#x7ED9;&#x5E94;&#x7528;&#x3002;</li>
</ul>
<h4 id="&#x793A;&#x4F8B;&#x4EE3;&#x7801;">&#x793A;&#x4F8B;&#x4EE3;&#x7801;</h4>
<p><code>rpc_server.py</code></p>
<pre><code class="lang-python"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-keyword">import</span> pika

connection = pika.BlockingConnection(
    pika.ConnectionParameters(host=<span class="hljs-string">&apos;localhost&apos;</span>))

channel = connection.channel()

channel.queue_declare(queue=<span class="hljs-string">&apos;rpc_queue&apos;</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fib</span><span class="hljs-params">(n)</span>:</span>
    <span class="hljs-keyword">if</span> n == <span class="hljs-number">0</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">elif</span> n == <span class="hljs-number">1</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> fib(n - <span class="hljs-number">1</span>) + fib(n - <span class="hljs-number">2</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_request</span><span class="hljs-params">(ch, method, props, body)</span>:</span>
    n = int(body)

    print(<span class="hljs-string">&quot; [.] fib(%s)&quot;</span> % n)
    response = fib(n)
    <span class="hljs-comment"># exchange&#x4E3A;&#x7A7A;&#x65F6;&#xFF0C;routing_key&#x5C31;&#x662F;&#x961F;&#x5217;&#x540D;</span>
    ch.basic_publish(exchange=<span class="hljs-string">&apos;&apos;</span>,
                     routing_key=props.reply_to,
                     properties=pika.BasicProperties(correlation_id = \
                                                         props.correlation_id),
                     body=str(response))
    ch.basic_ack(delivery_tag=method.delivery_tag)

channel.basic_qos(prefetch_count=<span class="hljs-number">1</span>)
channel.basic_consume(queue=<span class="hljs-string">&apos;rpc_queue&apos;</span>, on_message_callback=on_request)

print(<span class="hljs-string">&quot; [x] Awaiting RPC requests&quot;</span>)
channel.start_consuming()
</code></pre>
<blockquote>
<p>The server code is rather straightforward:</p>
<ul>
<li>(4) As usual we start by establishing the connection and declaring the queue.</li>
<li>(11) We declare our fibonacci function. It assumes only valid positive integer input. (Don&apos;t expect this one to work for big numbers, it&apos;s probably the slowest recursive implementation possible).</li>
<li>(19) We declare a callback for basic_consume, the core of the RPC server. It&apos;s executed when the request is received. It does the work and sends the response back.</li>
<li>(32) We might want to run more than one server process. In order to spread the load equally over multiple servers we need to set the prefetch_count setting.</li>
</ul>
</blockquote>
<p>&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x4EE3;&#x7801;&#x5F88;&#x76F4;&#x89C2;&#xFF1A;</p>
<ul>
<li>&#x7B2C;4&#x884C;&#xFF0C;&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#xFF0C;&#x58F0;&#x660E;&#x961F;&#x5217;</li>
<li>(11) &#x58F0;&#x660E;fibonacci&#x51FD;&#x6570;&#xFF0C;&#x53EA;&#x63A5;&#x6536;&#x6709;&#x6548;&#x7684;&#x6B63;&#x6574;&#x6570;&#x8F93;&#x5165;(&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5BF9;&#x5927;&#x6570;&#x4E0D;&#x53EF;&#x7528;&#xFF0C;&#x662F;&#x6700;&#x6162;&#x7684;&#x9012;&#x5F52;&#x5B9E;&#x73B0;)</li>
<li>(19) &#x9488;&#x5BF9;basic_consume &#x58F0;&#x660E;&#x4E86;&#x4E00;&#x4E2A;callback&#xFF0C; &#x8FD9;&#x662F;RPC&#x670D;&#x52A1;&#x5668;&#x7684;&#x6838;&#x5FC3;&#xFF0C;&#x5F53;&#x6536;&#x5230;&#x8BF7;&#x6C42;&#x7684;&#x65F6;&#x5019;&#x6267;&#x884C;&#xFF0C;&#x7136;&#x540E;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;</li>
<li>(32) &#x6211;&#x4EEC;&#x53EF;&#x80FD;&#x60F3;&#x8FD0;&#x884C;&#x591A;&#x4E2A;&#x670D;&#x52A1;&#x8FDB;&#x7A0B;&#xFF0C;&#x4E3A;&#x4E86;&#x5728;&#x591A;&#x4E2A;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x5E73;&#x5747;&#x5206;&#x914D;&#x8D1F;&#x8F7D;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x8BBE;&#x7F6E;prefetch_count&#x3002;</li>
</ul>
<p><code>rpc_client.py</code></p>
<pre><code class="lang-python"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-keyword">import</span> pika
<span class="hljs-keyword">import</span> uuid

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FibonacciRpcClient</span><span class="hljs-params">(object)</span>:</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.connection = pika.BlockingConnection(
            pika.ConnectionParameters(host=<span class="hljs-string">&apos;localhost&apos;</span>))

        self.channel = self.connection.channel()

        result = self.channel.queue_declare(queue=<span class="hljs-string">&apos;&apos;</span>, exclusive=<span class="hljs-keyword">True</span>)
        self.callback_queue = result.method.queue

        self.channel.basic_consume(
            queue=self.callback_queue,
            on_message_callback=self.on_response,
            auto_ack=<span class="hljs-keyword">True</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_response</span><span class="hljs-params">(self, ch, method, props, body)</span>:</span>
        <span class="hljs-keyword">if</span> self.corr_id == props.correlation_id:
            self.response = body

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">call</span><span class="hljs-params">(self, n)</span>:</span>
        self.response = <span class="hljs-keyword">None</span>
        self.corr_id = str(uuid.uuid4())
        <span class="hljs-comment"># exchange&#x4E3A;&#x7A7A;&#x65F6;&#xFF0C;routing_key&#x5C31;&#x662F;&#x961F;&#x5217;&#x540D;</span>
        self.channel.basic_publish(
            exchange=<span class="hljs-string">&apos;&apos;</span>,
            routing_key=<span class="hljs-string">&apos;rpc_queue&apos;</span>,
            properties=pika.BasicProperties(
                reply_to=self.callback_queue,
                correlation_id=self.corr_id,
            ),
            body=str(n))
        <span class="hljs-keyword">while</span> self.response <span class="hljs-keyword">is</span> <span class="hljs-keyword">None</span>:
            self.connection.process_data_events()
        <span class="hljs-keyword">return</span> int(self.response)


fibonacci_rpc = FibonacciRpcClient()

print(<span class="hljs-string">&quot; [x] Requesting fib(30)&quot;</span>)
response = fibonacci_rpc.call(<span class="hljs-number">30</span>)
print(<span class="hljs-string">&quot; [.] Got %r&quot;</span> % response)
</code></pre>
<blockquote>
<p>The client code is slightly more involved:</p>
<ul>
<li>(7) We establish a connection, channel and declare an exclusive &apos;callback&apos; queue for replies.</li>
<li>(16) We subscribe to the &apos;callback&apos; queue, so that we can receive RPC responses.</li>
<li>(18) The &apos;on_response&apos; callback executed on every response is doing a very simple job, for every response message it checks if the correlation_id is the one we&apos;re looking for. If so, it saves the response in self.response and breaks the consuming loop.</li>
<li>(24) Next, we define our main call method - it does the actual RPC request.</li>
<li>(25) In this method, first we generate a unique correlation_id number and save it - the &apos;on_response&apos; callback function will use this value to catch the appropriate response.</li>
<li>(28) Next, we publish the request message, with two properties: reply_to and correlation_id.</li>
<li>(32) At this point we can sit back and wait until the proper response arrives.</li>
<li>(33) And finally we return the response back to the user.</li>
</ul>
</blockquote>
<p>&#x5BA2;&#x6237;&#x7AEF;&#x4EE3;&#x7801;&#x7A0D;&#x5FAE;&#x590D;&#x6742;&#x4E00;&#x4E9B;&#xFF1A;</p>
<ul>
<li>(7) &#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#xFF0C;&#x7BA1;&#x9053;&#xFF0C;&#x4E3A;&#x54CD;&#x5E94;&#x58F0;&#x660E;&#x4E00;&#x4E2A;&#x72EC;&#x5360;&#x7684;callback&#x961F;&#x5217;(&#x5728;&#x6D88;&#x8D39;&#x8005;&#x5173;&#x95ED;&#x8FDE;&#x63A5;&#x540E;&#xFF0C;&#x8FD9;&#x4E2A;&#x961F;&#x5217;&#x4F1A;&#x88AB;&#x5220;&#x9664;)</li>
<li>(16) &#x8BA2;&#x9605;callback&#x961F;&#x5217;&#xFF0C;&#x8FD9;&#x6837;&#x624D;&#x80FD;&#x6536;&#x5230;RPC&#x7684;&#x54CD;&#x5E94;</li>
<li>(18) &#x5728;&#x6BCF;&#x4E2A;&#x54CD;&#x5E94;&#x4E2D;&#xFF0C;on_reponse &#x56DE;&#x8C03;&#x51FD;&#x6570;&#x4F1A;&#x88AB;&#x8C03;&#x7528;&#xFF0C;&#x8FD9;&#x91CC;&#x9762;&#x53EA;&#x662F;&#x6267;&#x884C;&#x4E86;&#x5F88;&#x7B80;&#x5355;&#x7684;&#x5DE5;&#x4F5C;&#xFF0C;&#x9488;&#x5BF9;&#x6BCF;&#x4E2A;&#x54CD;&#x5E94;&#x6D88;&#x606F;&#xFF0C;&#x5B83;&#x68C0;&#x67E5;correlation_id&#x662F;&#x5426;&#x662F;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;&#xFF0C;&#x5982;&#x679C;&#x662F;&#xFF0C;&#x5C31;&#x4FDD;&#x5B58;&#x54CD;&#x5E94;&#x4FE1;&#x606F;&#x5230;self.response&#xFF0C;&#x5E76;&#x505C;&#x6B62;&#x5FAA;&#x73AF;</li>
<li>(24) &#x63A5;&#x4E0B;&#x6765;&#x5B9A;&#x4E49;call&#x65B9;&#x6CD5;&#xFF0C;&#x5B83;&#x6267;&#x884C;&#x771F;&#x6B63;&#x7684;RPC&#x8BF7;&#x6C42;</li>
<li>(25)  &#x5728;call&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x9996;&#x5148;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x552F;&#x4E00;&#x7684;correlation_id&#x5E76;&#x4FDD;&#x5B58;&#x5B83;&#xFF0C;&#x56DE;&#x8C03;&#x51FD;&#x6570;<code>on_reponse</code>(21)&#x4F1A;&#x7528;&#x8FD9;&#x4E2A;&#x503C;&#x6765;&#x5339;&#x914D;&#x5BF9;&#x5E94;&#x7684;&#x54CD;&#x5E94;</li>
<li>(28) &#x63A5;&#x7740;&#xFF0C;&#x53D1;&#x5E03;&#x5E26;&#x6709;&#x4E24;&#x4E2A;&#x53C2;&#x6570;&#x7684;&#x8BF7;&#x6C42;&#x4FE1;&#x606F;&#xFF0C;reply_to &#x548C; correlation_id</li>
<li>(32) &#x6B64;&#x65F6;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5750;&#x4E0B;&#x6765;&#x7B49;&#x5F85;&#x54CD;&#x5E94;&#x7684;&#x5230;&#x6765;</li>
<li>(33) &#x6700;&#x540E;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x7ED9;&#x7528;&#x6237;</li>
</ul>
<p>&#x6539;&#x8FDB;&#x7248;&#xFF1A;&#x4F7F;&#x7528;exchange&#xFF0C;exchange_type=direct</p>
<p><code>rpc_server.py</code></p>
<pre><code class="lang-python"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-keyword">import</span> pika
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> random

connection = pika.BlockingConnection(
    pika.ConnectionParameters(host=<span class="hljs-string">&apos;localhost&apos;</span>))

channel = connection.channel()

<span class="hljs-comment"># rpc_queue_1&#x662F;rpc&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001;&#x8BF7;&#x6C42;&#x5230;&#x8FBE;&#x7684;&#x961F;&#x5217;&#xFF0C;fib_1&#x662F;&#x5BF9;&#x5E94;&#x7684;routing_key</span>
channel.queue_declare(queue=<span class="hljs-string">&apos;rpc_queue_1&apos;</span>)
channel.exchange_declare(exchange=<span class="hljs-string">&apos;rpc&apos;</span>, exchange_type=<span class="hljs-string">&apos;direct&apos;</span>)
channel.queue_bind(exchange=<span class="hljs-string">&apos;rpc&apos;</span>, queue=<span class="hljs-string">&apos;rpc_queue_1&apos;</span>, routing_key=<span class="hljs-string">&apos;fib_1&apos;</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fib</span><span class="hljs-params">(n)</span>:</span>
    n = random.randint(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)
    time.sleep(n*<span class="hljs-number">0.1</span>)
    <span class="hljs-keyword">return</span> n


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_request</span><span class="hljs-params">(ch, method, props, body)</span>:</span>
    n = int(body)

    print(<span class="hljs-string">&quot; [.] fib(%s)&quot;</span> % n)
    response = fib(n)
    ch.basic_publish(exchange=<span class="hljs-string">&apos;rpc&apos;</span>,
                     routing_key=<span class="hljs-string">&apos;fib_2&apos;</span>,
                     properties=pika.BasicProperties(correlation_id = \
                                                         props.correlation_id),
                     body=str(response))
    ch.basic_ack(delivery_tag=method.delivery_tag)

channel.basic_qos(prefetch_count=<span class="hljs-number">1</span>)
channel.basic_consume(queue=<span class="hljs-string">&apos;rpc_queue_1&apos;</span>, on_message_callback=on_request)

print(<span class="hljs-string">&quot; [x] Awaiting RPC requests&quot;</span>)
channel.start_consuming()
</code></pre>
<p><code>rpc_client.py</code></p>
<pre><code class="lang-python"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-keyword">import</span> pika
<span class="hljs-keyword">import</span> uuid

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FibonacciRpcClient</span><span class="hljs-params">(object)</span>:</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.connection = pika.BlockingConnection(
            pika.ConnectionParameters(host=<span class="hljs-string">&apos;localhost&apos;</span>))

        self.channel = self.connection.channel()
                <span class="hljs-comment"># rpc_queue_2&#x662F;rpc&#x670D;&#x52A1;&#x7AEF;&#x5904;&#x7406;&#x5B8C;&#x8BF7;&#x6C42;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x7684;&#x961F;&#x5217;&#xFF0C;fib_2&#x662F;&#x5BF9;&#x5E94;&#x7684;routing_key</span>
        self.channel.exchange_declare(exchange=<span class="hljs-string">&apos;rpc&apos;</span>, exchange_type=<span class="hljs-string">&apos;direct&apos;</span>)
        self.channel.queue_declare(queue=<span class="hljs-string">&apos;rpc_queue_2&apos;</span>)
        self.channel.queue_bind(exchange=<span class="hljs-string">&apos;rpc&apos;</span>, queue=<span class="hljs-string">&apos;rpc_queue_2&apos;</span>, routing_key=<span class="hljs-string">&apos;fib_2&apos;</span>)

        self.channel.basic_consume(
            queue=<span class="hljs-string">&apos;rpc_queue_2&apos;</span>,
            on_message_callback=self.on_response,
            auto_ack=<span class="hljs-keyword">True</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_response</span><span class="hljs-params">(self, ch, method, props, body)</span>:</span>
        <span class="hljs-keyword">if</span> self.corr_id == props.correlation_id:
            self.response = body

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">call</span><span class="hljs-params">(self, n)</span>:</span>
        self.response = <span class="hljs-keyword">None</span>
        self.corr_id = str(uuid.uuid4())
        self.channel.basic_publish(
            exchange=<span class="hljs-string">&apos;rpc&apos;</span>,
            routing_key=<span class="hljs-string">&apos;fib_1&apos;</span>,
            properties=pika.BasicProperties(
                <span class="hljs-comment"># reply_to=&apos;rpc_queue_1&apos;,</span>
                correlation_id=self.corr_id,
            ),
            body=str(n))
        <span class="hljs-keyword">while</span> self.response <span class="hljs-keyword">is</span> <span class="hljs-keyword">None</span>:
            self.connection.process_data_events()
        <span class="hljs-keyword">return</span> int(self.response)


fibonacci_rpc = FibonacciRpcClient()

print(<span class="hljs-string">&quot; [x] Requesting fib(n)&quot;</span>)

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">100</span>, <span class="hljs-number">1000</span>):
    response = fibonacci_rpc.call(i)
    print(<span class="hljs-string">&quot; [.] Got %r&quot;</span> % response)
</code></pre>
<p>&#x9898;&#x5916;&#x8BDD;&#xFF1A;&#x53EF;&#x4EE5;&#x5C1D;&#x8BD5;&#x8FD0;&#x884C;&#x591A;&#x4E2A;rpc_server.py&#xFF0C;&#x67E5;&#x770B;&#x5206;&#x53D1;&#x6D88;&#x606F;&#x7684;&#x72B6;&#x51B5;</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="topics.html" class="navigation navigation-prev " aria-label="Previous page: Topics">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="publisher_confirms.html" class="navigation navigation-next " aria-label="Next page: Publisher Confirms">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"RPC","level":"1.2.6","depth":2,"next":{"title":"Publisher Confirms","level":"1.2.7","depth":2,"path":"queue/publisher_confirms.md","ref":"queue/publisher_confirms.md","articles":[]},"previous":{"title":"Topics","level":"1.2.5","depth":2,"path":"queue/topics.md","ref":"queue/topics.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["livereload"],"pluginsConfig":{"livereload":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"queue/rpc.md","mtime":"2020-04-22T08:45:47.223Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-04-23T02:22:03.678Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

