
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Routing · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="topics.html" />
    
    
    <link rel="prev" href="publish_subscribe.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    开始
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    消息队列模式
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="hello_world.html">
            
                <a href="hello_world.html">
            
                    
                    Hello World
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="work_queues.html">
            
                <a href="work_queues.html">
            
                    
                    Work queues
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="publish_subscribe.html">
            
                <a href="publish_subscribe.html">
            
                    
                    Publish / Subscribe 
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.2.4" data-path="routing.html">
            
                <a href="routing.html">
            
                    
                    Routing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="topics.html">
            
                <a href="topics.html">
            
                    
                    Topics
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="rpc.html">
            
                <a href="rpc.html">
            
                    
                    RPC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.7" data-path="publisher_confirms.html">
            
                <a href="publisher_confirms.html">
            
                    
                    Publisher Confirms
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    服务端文档(Server Documentation)
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../server/configuration.md">
            
                <span>
            
                    
                    Configuration
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <span>
            
                    
                    分布式RabbitMQ(Distributed RabbitMQ)
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../distribute/overview.html">
            
                <a href="../distribute/overview.html">
            
                    
                    概述（Mirroring, Shovel, Federation Overview）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../distribute/clustering.html">
            
                <a href="../distribute/clustering.html">
            
                    
                    Clustering
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" >
            
                <a target="_blank" href="https://www.rabbitmq.com/ha.html">
            
                    
                    Queue Mirroring
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" >
            
                <a target="_blank" href="https://www.rabbitmq.com/reliability.html">
            
                    
                    Reliable Message Delivery
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" >
            
                <a target="_blank" href="https://www.rabbitmq.com/pacemaker.html">
            
                    
                    highly available
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Routing</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h4 id="&#x5185;&#x5BB9;&#x6458;&#x8981;">&#x5185;&#x5BB9;&#x6458;&#x8981;</h4>
<blockquote>
<p>In this tutorial we&apos;re going to add a feature to it - we&apos;re going to make it possible to subscribe only to a subset of the messages. For example, we will be able to direct only critical error messages to the log file (to save disk space), while still being able to print all of the log messages on the console.</p>
</blockquote>
<p>&#x6211;&#x4EEC;&#x60F3;&#x53EA;&#x8BA2;&#x9605;&#x4E00;&#x90E8;&#x5206;&#x7684;&#x6D88;&#x606F;&#x3002;&#x6BD4;&#x5982;&#x53EA;&#x628A;&#x5173;&#x952E;&#x7684;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x4FDD;&#x5B58;&#x5230;&#x78C1;&#x76D8;&#xFF0C;&#x5176;&#x4ED6;&#x7684;&#x4ECD;&#x7136;&#x6253;&#x5370;&#x5728;&#x7EC8;&#x7AEF;&#x4E0A;&#x3002;</p>
<h4 id="bindings">Bindings</h4>
<blockquote>
<p>A binding is a relationship between an exchange and a queue. This can be simply read as: the queue is interested in messages from this exchange.</p>
<p>Bindings can take an extra <code>routing_key</code> parameter. To avoid the confusion with a basic_publish parameter we&apos;re going to call it a binding key. This is how we could create a binding with a key:</p>
</blockquote>
<p>binding&#x662F;exchange&#x548C;queue&#x4E4B;&#x95F4;&#x7684;&#x7EBD;&#x5E26;&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x907F;&#x514D;&#x548C;basic_publish&#x91CC;&#x9762;&#x7684;routing_key&#x6DF7;&#x6DC6;&#xFF0C;&#x6211;&#x4EEC;&#x79F0;&#x4E4B;&#x4E3A;binding key</p>
<pre><code class="lang-python">channel.queue_bind(exchange=exchange_name,
                   queue=queue_name,
                   routing_key=<span class="hljs-string">&apos;black&apos;</span>)
</code></pre>
<h4 id="direct-exchange">Direct exchange</h4>
<blockquote>
<p>Our logging system from the previous tutorial broadcasts all messages to all consumers. We want to extend that to allow filtering messages based on their severity. For example we may want the script which is writing log messages to the disk to only receive critical errors, and not waste disk space on warning or info log messages.</p>
<p>We were using a <code>fanout</code> exchange, which doesn&apos;t give us too much flexibility - it&apos;s only capable of mindless broadcasting.</p>
<p>We will use a <code>direct</code> exchange instead. The routing algorithm behind a direct exchange is simple - a message goes to the queues whose <code>binding key</code> exactly matches the <code>routing key</code> of the message.</p>
<p>To illustrate that, consider the following setup:</p>
</blockquote>
<p>&#x4E4B;&#x524D;&#x7684;&#x65E5;&#x5FD7;&#x7CFB;&#x7EDF;&#x5E7F;&#x64AD;&#x6240;&#x6709;&#x6D88;&#x606F;&#x5230;&#x6D88;&#x8D39;&#x8005;&#xFF0C;&#x6211;&#x4EEC;&#x60F3;&#x901A;&#x8FC7;&#x6269;&#x5C55;&#x6765;&#x5B9E;&#x73B0;&#x6839;&#x636E;&#x4ED6;&#x4EEC;&#x7684;&#x4E25;&#x91CD;&#x7A0B;&#x5EA6;&#x6765;&#x8FC7;&#x6EE4;&#x6D88;&#x606F;&#x3002;&#x6BD4;&#x5982;&#x4E00;&#x4E9B;&#x4E25;&#x91CD;&#x9519;&#x8BEF;&#x5199;&#x5230;&#x78C1;&#x76D8;&#xFF0C;&#x4E0D;&#x8981;&#x8BA9;&#x65E0;&#x5173;&#x7D27;&#x8981;&#x7684;&#x4FE1;&#x606F;&#x6D6A;&#x8D39;&#x78C1;&#x76D8;&#x3002;</p>
<p>&#x4E4B;&#x524D;&#x7684;fanout exchange&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x7ED9;&#x6211;&#x4EEC;&#x592A;&#x591A;&#x7684;&#x7075;&#x6D3B;&#x6027;&#xFF0C;&#x5B83;&#x53EA;&#x662F;&#x65E0;&#x8111;&#x7684;&#x5E7F;&#x64AD;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x5C06;&#x4F7F;&#x7528;direct exchange&#xFF0C;&#x5B83;&#x7684;&#x8DEF;&#x7531;&#x7B97;&#x6CD5;&#x4E5F;&#x5F88;&#x7B80;&#x5355;&#x3002;&#x4E00;&#x4E2A;&#x6D88;&#x606F;&#x53EA;&#x4F20;&#x9012;&#x5230;<code>routing_key</code>&#x548C;<code>binding_key</code>&#x4E00;&#x6837;&#x7684;&#x961F;&#x5217;&#x4E0A;&#x3002;</p>
<p><img src="images/routing.png" alt="routing" style="zoom:50%;"></p>
<blockquote>
<p>In this setup, we can see the direct exchange X with two queues bound to it. The first queue is bound with binding key orange, and the second has two bindings, one with binding key black and the other one with green.</p>
<p>In such a setup a message published to the exchange with a routing key orange will be routed to queue Q1. Messages with a routing key of black or green will go to Q2. All other messages will be discarded.</p>
</blockquote>
<p>exchange X &#x548C;&#x4E24;&#x4E2A;&#x961F;&#x5217;&#x7ED1;&#x5B9A;&#x5230;&#x4E86;&#x4E00;&#x8D77;&#xFF0C;&#x7B2C;&#x4E00;&#x4E2A;&#x961F;&#x5217;&#x88AB;&#x7ED1;&#x5B9A;&#x5230;binding_key=orange&#xFF0C;&#x7B2C;&#x4E8C;&#x4E2A;&#x961F;&#x5217;&#x6709;&#x4E24;&#x4E2A;&#x7ED1;&#x5B9A;&#xFF0C;&#x5206;&#x522B;&#x662F;black&#x548C;green&#x3002;</p>
<p>&#x5F53;&#x6D88;&#x606F;&#x88AB;&#x53D1;&#x9001;&#x5230;exchange&#xFF0C;routing_key=orange&#x7684;&#x4F1A;&#x8DEF;&#x7531;&#x5230;Q1&#xFF0C;routing_key=black|green&#x4F1A;&#x88AB;&#x8DEF;&#x7531;&#x5230;Q2&#xFF0C;&#x5176;&#x4ED6;&#x7684;&#x5C31;&#x4F1A;&#x88AB;&#x4E22;&#x5F03;&#x3002;</p>
<h4 id="multiple-bindings">Multiple bindings</h4>
<blockquote>
<p>It is perfectly legal to bind multiple queues with the same binding key. In our example we could add a binding between X and Q1 with binding key black. In that case, the direct exchange will behave like fanout and will broadcast the message to all the matching queues. A message with routing key black will be delivered to both Q1 and Q2.</p>
</blockquote>
<p>&#x4F7F;&#x7528;&#x76F8;&#x540C;&#x7684;binding_key&#x7ED1;&#x5B9A;&#x591A;&#x4E2A;&#x961F;&#x5217;&#x662F;&#x5B8C;&#x5168;&#x5408;&#x6CD5;&#x7684;&#x3002;&#x5728;&#x6211;&#x4EEC;&#x7684;&#x793A;&#x4F8B;&#x4E2D;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;binding_key=black&#x5728;X&#x548C;Q1&#x4E4B;&#x95F4;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x7ED1;&#x5B9A;&#x3002;&#x5728;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;direct exchange&#x884C;&#x4E3A;&#x8DDF;fanout&#x4E00;&#x6837;&#xFF0C;&#x5E76;&#x5C06;&#x6D88;&#x606F;&#x5E7F;&#x64AD;&#x5230;&#x6240;&#x6709;&#x5339;&#x914D;&#x7684;&#x961F;&#x5217;&#x3002;&#x5E26;&#x6709;routing_key=black&#x7684;&#x6D88;&#x606F;&#x5C06;&#x88AB;&#x53D1;&#x9001;&#x5230;Q1&#x548C;Q2&#x3002;</p>
<p><img src="images/routing2.png" alt="multiple bindings" style="zoom:50%;"></p>
<h5 id="&#x793A;&#x4F8B;&#x4EE3;&#x7801;">&#x793A;&#x4F8B;&#x4EE3;&#x7801;</h5>
<p><img src="images/routing3.png" alt="routing3" style="zoom:50%;"></p>
<p><code>emit_log_direct.py</code></p>
<pre><code class="lang-python"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-keyword">import</span> pika
<span class="hljs-keyword">import</span> sys

connection = pika.BlockingConnection(
    pika.ConnectionParameters(host=<span class="hljs-string">&apos;localhost&apos;</span>))
channel = connection.channel()

channel.exchange_declare(exchange=<span class="hljs-string">&apos;direct_logs&apos;</span>, exchange_type=<span class="hljs-string">&apos;direct&apos;</span>)

severity = sys.argv[<span class="hljs-number">1</span>] <span class="hljs-keyword">if</span> len(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-string">&apos;info&apos;</span>
message = <span class="hljs-string">&apos; &apos;</span>.join(sys.argv[<span class="hljs-number">2</span>:]) <span class="hljs-keyword">or</span> <span class="hljs-string">&apos;Hello World!&apos;</span>
channel.basic_publish(
    exchange=<span class="hljs-string">&apos;direct_logs&apos;</span>, routing_key=severity, body=message)
print(<span class="hljs-string">&quot; [x] Sent %r:%r&quot;</span> % (severity, message))
connection.close()
</code></pre>
<p><code>receive_logs_direct.py</code></p>
<pre><code class="lang-python"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-keyword">import</span> pika
<span class="hljs-keyword">import</span> sys

connection = pika.BlockingConnection(
    pika.ConnectionParameters(host=<span class="hljs-string">&apos;localhost&apos;</span>))
channel = connection.channel()

channel.exchange_declare(exchange=<span class="hljs-string">&apos;direct_logs&apos;</span>, exchange_type=<span class="hljs-string">&apos;direct&apos;</span>)

result = channel.queue_declare(queue=<span class="hljs-string">&apos;&apos;</span>, exclusive=<span class="hljs-keyword">True</span>)
queue_name = result.method.queue

severities = sys.argv[<span class="hljs-number">1</span>:]
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> severities:
    sys.stderr.write(<span class="hljs-string">&quot;Usage: %s [info] [warning] [error]\n&quot;</span> % sys.argv[<span class="hljs-number">0</span>])
    sys.exit(<span class="hljs-number">1</span>)

<span class="hljs-keyword">for</span> severity <span class="hljs-keyword">in</span> severities:
    channel.queue_bind(
        exchange=<span class="hljs-string">&apos;direct_logs&apos;</span>, queue=queue_name, routing_key=severity)

print(<span class="hljs-string">&apos; [*] Waiting for logs. To exit press CTRL+C&apos;</span>)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">callback</span><span class="hljs-params">(ch, method, properties, body)</span>:</span>
    print(<span class="hljs-string">&quot; [x] %r:%r&quot;</span> % (method.routing_key, body))


channel.basic_consume(
    queue=queue_name, on_message_callback=callback, auto_ack=<span class="hljs-keyword">True</span>)

channel.start_consuming()
</code></pre>
<p>&#x5982;&#x679C;&#x4F60;&#x53EA;&#x60F3;&#x4FDD;&#x5B58;warning &#x548C; error &#x7684;&#x65E5;&#x5FD7;&#x4FE1;&#x606F;&#xFF0C;&#x53EA;&#x8981;&#x8F93;&#x5165;&#x5982;&#x4E0B;&#x5185;&#x5BB9;&#xFF1A;</p>
<pre><code class="lang-python">python receive_logs_direct.py warning error &gt; logs_from_rabbit.log
</code></pre>
<p>&#x5982;&#x679C;&#x4F60;&#x60F3;&#x5728;&#x5C4F;&#x5E55;&#x4E0A;&#x770B;&#x5230;&#x6240;&#x6709;&#x7684;&#x65E5;&#x5FD7;&#x4FE1;&#x606F;&#xFF0C;&#x8F93;&#x5165;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code class="lang-python">python receive_logs_direct.py info warning error
<span class="hljs-comment"># =&gt; [*] Waiting for logs. To exit press CTRL+C</span>
</code></pre>
<p>&#x751F;&#x4EA7;&#x4E00;&#x4E2A;&#x9519;&#x8BEF;&#x6D88;&#x606F;</p>
<pre><code class="lang-python">python emit_log_direct.py error <span class="hljs-string">&quot;Run. Run. Or it will explode.&quot;</span>
<span class="hljs-comment"># =&gt; [x] Sent &apos;error&apos;:&apos;Run. Run. Or it will explode.&apos;</span>
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="publish_subscribe.html" class="navigation navigation-prev " aria-label="Previous page: Publish / Subscribe ">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="topics.html" class="navigation navigation-next " aria-label="Next page: Topics">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Routing","level":"1.2.4","depth":2,"next":{"title":"Topics","level":"1.2.5","depth":2,"path":"queue/topics.md","ref":"queue/topics.md","articles":[]},"previous":{"title":"Publish / Subscribe ","level":"1.2.3","depth":2,"path":"queue/publish_subscribe.md","ref":"queue/publish_subscribe.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["livereload"],"pluginsConfig":{"livereload":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"queue/routing.md","mtime":"2020-04-21T11:37:51.084Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-04-23T02:22:03.678Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

